
box: maven:3-jdk-7

build:
  steps:
    - script:
      name: create cache directory
      code: |
        mkdir -p $WERCKER_CACHE_DIR/.m2/repository
        ln -sf $WERCKER_CACHE_DIR/.m2/repository /root/.m2/repository
    - script:
      name: maven package
      code: |
        mvn clean package -Prelease -Dmaven.test.skip=true
        cp target/KindleReport-0.0.1-SNAPSHOT.jar target/app.jar
deploy:
  steps:
    - add-to-known_hosts:
      hostname: $DEPLOY_HOSTNAME
    - mktemp:
      envvar: PRIVATEKEY_PATH
    - create-file:
      name: write key
      filename: $PRIVATEKEY_PATH
      content: $SSH_KEY_PRIVATE
      overwrite: true
      hide-from-log: true
    - script:
      name: deploy application
      code: |
        pwd
        ls -la
        scp target/app.jar $DEPLOY_USERNAME@$DEPLOY_HOSTNAME:$APP_HOME/target/
   - script:
      name: restart application
      code: |
        ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $DEPLOY_USERNAME@$DEPLOY_HOSTNAME 'cd $APP_HOME && ./docker_build.sh && ./docker_run.sh'
