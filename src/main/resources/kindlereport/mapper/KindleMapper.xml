<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kindlereport.mapper.KindleMapper">
	
	<select id="selectKindle" resultType="Map">
		select
			asin,
			title,
			releaseDate,
			detailPageURL,
			largeImage
		from
			Kindle
		where
			asin = #{asin}
	</select>
	
	<select id="selectKindleList" resultType="kindlereport.model.KindleTile">
		select
			K.asin,
			K.releaseDate,
			I.tileTitle as title,
			K.mediumImage
		from
			Kindle K INNER JOIN KindleRegist R ON K.asin = R.asin LEFT JOIN KindleMyInfo I ON K.asin = I.asin
		where
			I.isNovel = 0
			and I.isMagazine = 0
			and I.isAdult = 0
			and K.isAdultProduct = 0
		<if test="order == 4">
			and R.deleteTime is not null
		</if>
		<if test="limitedFree == true">
			and I.isLimitedFree = true
		</if>
		order by
		<choose>
			<when test="order == null or order == 1">
				K.releaseDate desc, I.tileTitle asc
			</when>
			<when test="order == 2">
				K.releaseDate asc, I.tileTitle asc
			</when>
			<when test="order == 3">
				R.insertTime desc
			</when>
			<when test="order == 4">
				R.deleteTime desc
			</when>
			<otherwise>
				K.releaseDate desc, I.tileTitle asc
			</otherwise>
		</choose>
		LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<select id="selectKindleListByTag" resultType="kindlereport.model.KindleTile">
		select
			K.asin,
			K.releaseDate,
			I.tileTitle as title,
			K.mediumImage
		from
			Kindle K INNER JOIN KindleRegist R ON K.asin = R.asin LEFT JOIN KindleMyInfo I ON K.asin = I.asin
		where
			I.isNovel = 0
			and I.isMagazine = 0
			and I.isAdult = 0
			and K.isAdultProduct = 0
		<if test="order == 4">
			and R.deleteTime is not null
		</if>
		<if test="limitedFree == true">
			and I.isLimitedFree = true
		</if>
		<foreach item="id" index="index" collection="tagId">
			and exists (select 'X' from tagmap T where K.asin = T.asin and T.tag_id = #{id})
		</foreach>
		order by
		<choose>
			<when test="order == null or order == 1">
				K.releaseDate desc, I.tileTitle asc
			</when>
			<when test="order == 2">
				K.releaseDate asc, I.tileTitle asc
			</when>
			<when test="order == 3">
				R.insertTime desc
			</when>
			<when test="order == 4">
				R.deleteTime desc
			</when>
			<otherwise>
				K.releaseDate desc, I.tileTitle asc
			</otherwise>
		</choose>
		LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<select id="selectRereaseDateList" parameterType="String" resultType="String">
<!-- 		select distinct releaseDate from Kindle order by releaseDate desc LIMIT 10 -->
		select distinct
			K.releaseDate
		from
			Kindle K LEFT JOIN KindleMyInfo I ON K.asin = I.asin
		where
			K.releaseDate >= #{date}
			and I.isNovel = 0
			and I.isMagazine = 0
			and I.isAdult = 0
			and K.isAdultProduct = 0
		order by
			K.releaseDate
	</select>
	
	<select id="selectDayKindleList" parameterType="String" resultType="kindlereport.model.KindleTile">
		select
			K.asin,
			K.releaseDate,
			I.tileTitle as title,
			K.mediumImage
		from
			Kindle K LEFT JOIN KindleMyInfo I ON K.asin = I.asin
		where
			K.releaseDate = #{releaseDate}
			and I.isNovel = 0
			and I.isMagazine = 0
			and I.isAdult = 0
			and K.isAdultProduct = 0
		order by
			I.tileTitle asc
	</select>
	
	<select id="selectKindleByAsin" resultType="kindlereport.model.KindleDetail">
		select
			K.asin,
			K.author,
			K.publisher,
			K.releaseDate,
			K.title,
			K.content,
			K.detailPageURL,
			K.largeImage,
			R.insertTime,
			R.updateTime,
			R.deleteTime
		from
			Kindle K INNER JOIN KindleRegist R ON K.asin = R.asin
		where
			K.asin = #{asin}
	</select>
</mapper>
